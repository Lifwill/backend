import gulp from 'gulp';
import babel from 'gulp-babel';
import print from 'gulp-print';
import nodemon from 'gulp-nodemon';
import path from 'path';

// contains the private config, of course do not commit it
import devConfig from './devConfig';

// build sources
gulp.task('build', () => {
  return gulp.src('src/**/*.js')          // #1. select all js files in the src folder
        .pipe(print())                    // #2. print each file in the stream
      .pipe(babel())                      // #3. transpile ES2015 to ES5 using ES2015 preset
      .pipe(gulp.dest('dist'));           // #4. copy the results to the build folder
});

// start the server with restat in case of change using nodemon
gulp.task('dev', ['build'], () => {
  Object.assign(process.env, devConfig);                // assign the dev config to the environment process
  nodemon({
    script: path.join('dist', 'server.js'),             // the path of the file generated by the build
    ext: 'js',
    ignore: ['node_modules/**/*.js', 'dist/**/*.js'],
    tasks: ['build']                                    // the task that should relaunch nodemon before restarting the server
})});
